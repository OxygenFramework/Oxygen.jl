<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ApexCharts with Preact</title>
    <style>
        #chart {
            width: 500px;
            height: 400px;
        }
    </style>
</head>
<body>
    <div id="chart"></div>
    <script type="module">
        import { h, Fragment, render } from 'https://esm.sh/preact@10.19.3';
        import { useEffect, useState } from 'https://esm.sh/preact@10.19.3/hooks';
        import ApexCharts from 'https://esm.sh/apexcharts@3.45.0';

        function EndpointPieChart() {
            const [chartData, setChartData] = useState({ series: [], labels: [] });

            useEffect(() => {
                // Fetch data
                fetch('http://127.0.0.1:8080/docs/metrics/data')
                    .then(response => response.json())
                    .then(data => {
                        const endpointsData = data.endpoints;
                        const series = [];
                        const labels = [];

                        for (const endpoint in endpointsData) {
                            labels.push(endpoint);
                            series.push(endpointsData[endpoint].total_requests);
                        }

                        setChartData({ series, labels });
                    })
                    .catch(error => console.error('Error fetching data:', error));
            }, []);

            useEffect(() => {
                // Render chart if data is available
                if (chartData.series.length > 0 && chartData.labels.length > 0) {
                    const options = {
                        chart: {
                            type: 'pie',
                            height: '100%'
                        },
                        series: chartData.series,
                        labels: chartData.labels,
                        responsive: [{
                            breakpoint: 480,
                            options: {
                                chart: {
                                    width: 200
                                },
                                legend: {
                                    position: 'bottom'
                                }
                            }
                        }]
                    };

                    var chart = new ApexCharts(document.querySelector("#chart"), options);
                    chart.render();
                }
            }, [chartData]); // Depend on chartData

            return h('div', null);
        }


        function Chart() {
            useEffect(() => {
                const options = {
                    chart: {
                        type: 'bar',
                        height: '100%'
                    },
                    series: [{
                        name: 'sales',
                        data: [30, 40, 453, 50, 49, 60, 70, 91, 125]
                    }],
                    xaxis: {
                        categories: [1991, 1992, 1993, 1994, 1995, 1996, 1997, 1998, 1999]
                    }
                };

                var chart = new ApexCharts(document.querySelector("#chart"), options);
                chart.render();
            }, []);

            return h('div', null);
        }
        

        render(h(EndpointPieChart), document.querySelector("#chart"));
    </script>
</body>
</html>
